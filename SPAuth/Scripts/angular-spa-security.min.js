angular.module("security",[]).constant("security.urls",{site:"/",join:"/api/account/register",login:"/token",logout:"/api/account/logout",userInfo:"/api/account/userInfo",changePassword:"/api/account/changePassword",externalLogins:"/api/account/externalLogins",registerExternal:"/api/account/registerExternal"}).factory("security.api",["$http","security.urls",function(e,t){var n={"Content-Type":"application/x-www-form-urlencoded"};var r=function(e){var t=function(e){var n="";var r,i,s,o;angular.forEach(e,function(e,u){if(e instanceof Array){for(o=0;o<e.length;++o){r=e[o];i=u+"["+o+"]";s={};s[i]=r;n+=t(s)+"&"}}else if(e instanceof Object){angular.forEach(e,function(e,r){i=u+"["+r+"]";s={};s[i]=e;n+=t(s)+"&"})}else if(e!==undefined&&e!==null){n+=encodeURIComponent(u)+"="+encodeURIComponent(e)+"&"}});return n.length?n.substr(0,n.length-1):n};return angular.isObject(e)&&String(e)!=="[object File]"?t(e):e};var i={getUserInfo:function(n){return e({url:t.userInfo,method:"GET",headers:{Authorization:"Bearer "+n}})},login:function(i){return e({method:"POST",url:t.login,data:r(i),headers:n})},logout:function(){return e({method:"POST",url:t.logout})},register:function(n){return e({method:"POST",url:t.join,data:n})},changePassword:function(n){return e({method:"POST",url:t.changePassword,data:n})},getExternalLogins:function(){return e({method:"GET",url:t.externalLogins+"?returnUrl="+encodeURIComponent(t.site)+"&generateState=true",isArray:true})},registerExternal:function(n,r){return e({method:"POST",url:t.registerExternal,data:r,headers:{Authorization:"Bearer "+n}})}};return i}]).provider("security",["security.urls",function(e){var t=this;t.registerThenLogin=true;t.usePopups=false;t.urls={login:"/login",registerExternal:"/registerExternal",postLogout:"/login",home:"/"};t.apiUrls=e;t.events={login:null,logout:null,register:null,reloadUser:null,closeOAuthWindow:null};t.$get=["security.api","$q","$http","$location","$timeout",function(e,n,r,i,s){var o=null;var u=function(e){var t={},n,r,i,s,o,u,a;if(e===null){return t}n=e.split("&");for(var f=0;f<n.length;f++){r=n[f];i=r.indexOf("=");if(i===-1){s=r;o=null}else{s=r.substr(0,i);o=r.substr(i+1)}u=decodeURIComponent(s);a=decodeURIComponent(o);t[u]=a}return t};var a=function(e,t){if(e){if(e=="clear"){localStorage.removeItem("accessToken");sessionStorage.removeItem("accessToken");delete r.defaults.headers.common.Authorization}else{if(t)localStorage.accessToken=e;else sessionStorage.accessToken=e;r.defaults.headers.common.Authorization="Bearer "+e}}return sessionStorage.accessToken||localStorage.accessToken};var f=function(e){if(e=="clear"){delete localStorage.redirectTarget;return}if(e)localStorage.redirectTarget=e;return localStorage.redirectTarget};var l=function(r,s,o){var u=n.defer();if(r.error){u.reject({message:r.error})}else{e.getUserInfo(r.access_token).success(function(e){if(e.hasRegistered){a(r.access_token,o);h.user=e;h.redirectAuthenticated(f()||t.urls.home);if(t.events.login)t.events.login(h,e);u.resolve(h.user)}else{h.externalUser=e;h.externalUser.access_token=r.access_token;h.externalUser.provider=s;if(o!=null)localStorage.rememberMe=o;i.path(t.urls.registerExternal);u.reject()}})}return u.promise};var c=function(){if(i.path().indexOf("access_token")!=-1){var n=u(i.path().substring(1));i.path("/");if(window.opener){window.opener.external_data=n;window.close()}else{var r=JSON.parse(localStorage.loginProvider);var s=false;if(localStorage.rememberMe){s=JSON.parse(localStorage.rememberMe);delete localStorage.rememberMe}delete localStorage.loginProvider;l(n,r,s)}}if(a()){a(a());e.getUserInfo(a()).success(function(e){h.user=e;if(t.events.reloadUser)t.events.reloadUser(h,e)})}e.getExternalLogins().success(function(e){h.externalLogins=e})};var h=this;h.user=null;h.externalUser=null;h.externalLogins=[];h.login=function(r){var i=n.defer();r.grant_type="password";e.login(r).success(function(e){a(e.access_token,r.rememberMe);h.user=e;h.redirectAuthenticated(f()||t.urls.home);if(t.events.login)t.events.login(h,e);i.resolve(h.user)}).error(function(e){i.reject(e)});return i.promise};h.loginWithExternal=function(e,r){var i=n.defer();if(t.usePopups){var u=window.open(e.url,"frame","resizeable,height=510,width=380");s.cancel(o);o=s(function a(){if(!u.closed){o=s(a,500);return}if(t.events.closeOAuthWindow)t.events.closeOAuthWindow(h,window.external_data);if(typeof window.external_data==="undefined"){i.reject();return}var n=window.external_data;delete window.external_data;i.resolve(l(n,e,r.rememberMe))},500)}else{if(r!=null&&r.rememberMe!=null)localStorage.rememberMe=JSON.stringify(r.rememberMe);localStorage.loginProvider=JSON.stringify(e);window.location.href=e.url}return i.promise};h.logout=function(){var r=n.defer();e.logout().success(function(){h.user=null;a("clear");f("clear");if(t.events.login)t.events.logout(h);i.path(t.urls.postLogout);r.resolve()}).error(function(e){r.reject(e)});return r.promise};h.register=function(r){var i=n.defer();e.register(r).success(function(){if(t.events.register)t.events.register(h);if(t.registerThenLogin){h.login(r).then(function(e){i.resolve(e)},function(e){i.reject(e)})}else{i.resolve()}}).error(function(e){i.reject(e)});return i.promise};h.registerExternal=function(){var t=n.defer();if(!h.externalUser){t.reject()}else{e.registerExternal(h.externalUser.access_token,h.externalUser).success(function(){t.resolve(h.loginWithExternal(h.externalUser.provider));h.externalUser=null}).error(function(e){t.reject(e)})}return t.promise};h.changePassword=function(t){var r=n.defer();e.changePassword(t).success(function(){r.resolve()}).error(function(e){r.reject(e)});return r.promise};h.authenticate=function(){if(a())return;if(!f())f(i.path());i.path(t.urls.login)};h.redirectAuthenticated=function(e){if(!a())return;if(f())f("clear");i.path(e)};c();return h}]}])