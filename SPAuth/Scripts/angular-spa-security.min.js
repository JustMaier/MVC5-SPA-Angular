angular.module("security",[]).constant("security.urls",{join:"/api/account/register",login:"/token",logout:"/api/account/logout",userInfo:"/api/account/userInfo",changePassword:"/api/account/changePassword"}).factory("security.api",["$http","$q","security.urls",function(e,t,n){var r=this;var i={"Content-Type":"application/x-www-form-urlencoded"};var s=function(e){var t=function(e){var n="";var r,i,s,o,u,a,f;for(r in e){i=e[r];if(i instanceof Array){for(f=0;f<i.length;++f){u=i[f];s=r+"["+f+"]";a={};a[s]=u;n+=t(a)+"&"}}else if(i instanceof Object){for(o in i){u=i[o];s=r+"["+o+"]";a={};a[s]=u;n+=t(a)+"&"}}else if(i!==undefined&&i!==null){n+=encodeURIComponent(r)+"="+encodeURIComponent(i)+"&"}}return n.length?n.substr(0,n.length-1):n};return angular.isObject(e)&&String(e)!=="[object File]"?t(e):e};var r={getUserInfo:function(t){return e({url:n.userInfo,method:"GET"})},login:function(t){return e({method:"POST",url:n.login,data:s(t),headers:i})},logout:function(){return e({method:"POST",url:n.logout})},register:function(t){return e({method:"POST",url:n.join,data:t})},changePassword:function(t){return e({method:"POST",url:n.changePassword,data:t})}};return r}]).provider("security",["security.urls",function(e){var t=this;t.registerThenLogin=true;t.urls={login:"/login",postLogout:"/login",home:"/"};t.apiUrls=e;t.events={login:null,logout:null,register:null,reloadUser:null};t.$get=["security.api","$q","$http","$location",function(e,n,r,i){var s=null;var o=function(e,t){if(e!=null){if(e=="clear"){localStorage.removeItem("accessToken");sessionStorage.removeItem("accessToken");delete r.defaults.headers.common["Authorization"]}else{if(t)localStorage["accessToken"]=e;else sessionStorage["accessToken"]=e;r.defaults.headers.common["Authorization"]="Bearer "+e}}return sessionStorage["accessToken"]||localStorage["accessToken"]};var u=this;u.user=null;u.login=function(r){var i=n.defer();r.grant_type="password";e.login(r).success(function(e){o(e.access_token,r.rememberMe);u.user=e;u.redirectAuthenticated(s||t.urls.home);if(t.events.login)t.events.login(u,e);i.resolve(u.user)}).error(function(e){i.reject(e)});return i.promise};u.logout=function(){var r=n.defer();e.logout().success(function(){u.user=null;o("clear");s=null;if(t.events.login)t.events.logout(u);i.path(t.urls.postLogout);r.resolve()}).error(function(e){r.reject(e)});return r.promise};u.register=function(r){var i=n.defer();e.register(r).success(function(){if(t.events.register)t.events.register(u);if(t.registerThenLogin){u.login(r).then(function(e){i.resolve(e)},function(e){i.reject(e)})}else{i.resolve()}}).error(function(e){i.reject(e)});return i.promise};u.changePassword=function(t){var r=n.defer();e.changePassword(t).success(function(){r.resolve()}).error(function(e){r.reject(e)});return r.promise};u.authenticate=function(){if(o()!=null)return;target=i.path();i.path(t.urls.login)};u.redirectAuthenticated=function(e){if(o()==null)return;i.path(e)};if(o()!=null){o(o());e.getUserInfo(o()).success(function(e){u.user=e;if(t.events.reloadUser)t.events.reloadUser(u,e)})}return u}]}])